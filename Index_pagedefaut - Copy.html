<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style>

.boundary {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
  stroke-linecap: round;
}

.feature--canton {
  fill: #bbb;
}

.feature--lake {
  fill: steelblue;
  fill-opacity: .8;
}

.feature :hover {
  fill: orange;
}
</style>
<script src="//d3js.org/d3.v5.min.js"></script>
<script src="//d3js.org/topojson.v3.min.js"></script>

<!-- <script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script> -->

<script src="//d3js.org/d3-scale.v3.min.js"></script>
</head>
<body>

<script>


var datapilot, dpdv1, dpdv2 , color = null; 

function getDV1DV2(){

    dpdv1 =   datapilot.map(function(d,i) {
      return {
        value: +d.DV1_participation_percent,
        index: i    
      };
    });

  dpdv2 =  datapilot.map(function(d,i) {
      return {
        value: +d.DV2_participation_percent,
        index: i    
      };
  });

  debugger;
}

  // préparation des données

 // datapilotDV1 = Object.assign(new Map(d3.csvParse(await FileAttachment("datapilot.csv").text(),({RegionsID, CANTON17nom, DV1_participation_percent}) => ['RegionsID', 'CANTON17nom', +'DV1_participation_percent'])),{title: "Taux de participation aux questionnaires de ménage (%) 2018"});






function readCSV() {
  d3.csv("datapilot.csv", function(d) {
  datapilot= {
    RegionsID: +d.RegionsID, // convert "RegionsID" column to number
    CANTON17nom: d.CANTON17nom,
    DV1_participation_percent: d.DV1_participation_percent ,
    DV2_participation_percent: d.DV2_participation_percent
    }
  }
  );
  
}

function displayMap1(){
 

 // console.log(rows);   


//color = f(t);
//color = d3.scaleQuantize([1, 100], d3.schemeBlues[9]);

/* var fill = d3.scale.linear()
    .domain([datapilot['DV1_participation_percent'].min, datapilot['DV1_participation_percent'].max])
    .range(["brown", "steelblue"]); */

   // dpdv1 = d3.map(datapilot, function(d){return +d['DV1_participation_percent']});
   // dpdv2 = d3.map(datapilot, function(d){return +d['DV2_participation_percent']});

    

  

// datapilotDV2 = Object.assign(new Map(d3.csvParse(await FileAttachment("datapilot.csv").text(), ({RegionsID, CANTON17nom, DV2_participation_percent
// }) => [RegionsID, CANTON17nom, DV2_participation_percent])), {title: "Taux de participation aux questionnaires de ménage et aux questionnaires individuelles (%) 2018"});

  debugger;
    // visualisation

  var width = 960,
      height = 500;

      debugger;
  //var path = d3.geo.path().projection(null);

  var path = d3.geoPath() ; //.projection(null);

  var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);
  // resources
  // 20191210210940
  // https://bl.ocks.org/mbostock/raw/10024231/3ad08272674371b4a4bec221d97d7a5fbf20525e/ch.json
  // https://bl.ocks.org/mbostock/10024231
  //usa : https://bl.ocks.org/mbostock/4206573
  // id des cantons suisses https://www.bfs.admin.ch/bfs/fr/home/statistiques/catalogues-banques-donnees/cartes.assetdetail.453856.html

  //generate ch.json using procedure : https://github.com/interactivethings/swiss-maps
  // downloaded swiss topojson : https://github.com/greenore/swiss-maps

   d3.json("swiss-maps-master/topo/ch.json").then(function( ch) {
   // if (error) throw error;
    debugger; // le navigateur s'arrete ici.
    svg.append("g")
        .attr("class", "feature feature--canton")
      .selectAll("path")
        .data(topojson.feature(ch, ch.objects.cantons).features)
      .enter().append("path")
        .attr("d", path)
        //.style("fill", function(d) { return fill(path.area(datapilot.find(dp=> dp['RegionsID']==d.id).DV1_participation_percent)); })
      .style("fill", function(d){ return color(datapilot.find(dp=> dp['RegionsID']==d.id).DV1_participation_percent)})
      .append("title").text(d => `${datapilot.find(dp=> dp['RegionsID']==d.id).CANTON17nom} , ${datapilot.find(dp=> dp['RegionsID']==d.id).DV1_participation_percent} % `);
      

    svg.append("g")
        .attr("class", "feature feature--lake")
      .selectAll("path")
        .data(topojson.feature(ch, ch.objects.lakes).features)
      .enter().append("path")
        .attr("d", path);

    svg.append("path")
        .datum(topojson.mesh(ch, ch.objects.cantons, function(a, b) { return a !== b; }))
        .attr("class", "boundary boundary--cantons")
        .style("stroke-width", "1px")
        .attr("d", path); 
  });
}

function readCSV_Original() {
  d3.csv("datapilot.csv", function(d) {
  return {
    RegionsID: +d.RegionsID, // convert "RegionsID" column to number
    CANTON17nom: d.CANTON17nom,
    DV1_participation_percent: d.DV1_participation_percent ,
    DV2_participation_percent: d.DV2_participation_percent
  };
  }).then(function(d){
    debugger;
    datapilot = d;
    getDV1DV2();
    
    //dpdv1 = d3.map(datapilot, function(d){return +d['DV1_participation_percent']});
    //dpdv2 = d3.map(datapilot, function(d){return +d['DV2_participation_percent']});

    

    debugger;
    color = d3.scaleQuantize()
        .domain([d3.min(dpdv1, d => d.value),d3.max(dpdv1, d => d.value)])
        .range(['grey','lightblue', 'blue','darkblue']);
    
    debugger;
    displayMap1();

  });
}

readCSV_Original();

</script>
</body>